<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaskBoard</title>
    <meta name="theme-color" content="#0EA5E9" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      /* Telegram-like dark navy theme overrides */
      .tg-dark body.bg-slate-50 { background-color: #0e1525 !important; }
      .tg-dark .text-slate-900, .tg-dark .text-slate-800 { color: #e5e7eb !important; }
      .tg-dark .text-slate-700, .tg-dark .text-slate-600, .tg-dark .text-slate-500 { color: #cbd5e1 !important; }
      /* Make surfaces slightly lighter than the dark background */
      .tg-dark .bg-white { background-color: #1b2738 !important; }
      .tg-dark .ring-slate-200 { --tw-ring-color: #2a3550 !important; border-color: #2a3550 !important; }
      .tg-dark .shadow-sm { box-shadow: 0 1px 2px rgba(0,0,0,0.6) !important; }
      .tg-dark header.bg-gradient-to-r { background-image: linear-gradient(90deg, #0b3b7e, #0e5a7f) !important; }
      .tg-dark .text-emerald-600 { color: #34d399 !important; }
      .tg-dark .text-sky-600 { color: #38bdf8 !important; }
      .tg-dark .text-indigo-600 { color: #818cf8 !important; }
      .tg-dark .text-slate-700 { color: #cbd5e1 !important; }
      .tg-dark .bg-sky-600 { background-color: #0284c7 !important; }
      .tg-dark .bg-amber-500 { background-color: #d97706 !important; }
      .tg-dark .bg-emerald-600 { background-color: #059669 !important; }
      .tg-dark .bg-rose-600 { background-color: #e11d48 !important; }
      .tg-dark .bg-rose-50 { background-color: #2b1220 !important; }
      .tg-dark .text-rose-700 { color: #fecaca !important; }
      .tg-dark .ring-slate-200 { border-color: #2a3550 !important; }
    </style>
    <script>
      // Call ready ASAP to prevent Telegram from showing the load overlay
      (function(){
        try {
          if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            if (typeof window.Telegram.WebApp.expand === 'function') {
              window.Telegram.WebApp.expand();
            }
            try { window.Telegram.WebApp.setHeaderColor('#0b3b7e'); } catch(_e) {}
            // Apply Telegram color scheme (prefer dark)
            try {
              var cs = window.Telegram.WebApp.colorScheme;
              var root = document.documentElement;
              if (cs === 'dark' || !cs) { root.classList.add('tg-dark'); }
            } catch(_e) {}
            try {
              window.Telegram.WebApp.onEvent('themeChanged', function(){
                try {
                  var cs2 = window.Telegram.WebApp.colorScheme;
                  var root2 = document.documentElement;
                  if (cs2 === 'dark') root2.classList.add('tg-dark'); else root2.classList.remove('tg-dark');
                } catch(_e) {}
              });
            } catch(_e) {}
          }
        } catch (e) {}
      })();
      // Extra fallbacks
      document.addEventListener('DOMContentLoaded', function(){
        try { window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.ready(); } catch(e) {}
      });
      window.addEventListener('load', function(){
        try { window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.ready(); } catch(e) {}
        setTimeout(function(){
          try { window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.ready(); } catch(e) {}
        }, 500);
      });
    </script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div id="root">
      <div class="min-h-screen flex items-center justify-center p-6">
        <div class="w-full max-w-md text-center">
          <div class="mx-auto h-12 w-12 rounded-full bg-sky-100 flex items-center justify-center mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-6 w-6 text-sky-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6l4 2"/></svg>
          </div>
          <h2 class="text-lg font-semibold text-slate-800 mb-1">Загрузка TaskBoard…</h2>
          <p class="text-sm text-slate-500">Если загрузка длится дольше обычного, закрой окно и открой снова из Telegram.</p>
        </div>
      </div>
    </div>
    <script>
      const useEffect = React.useEffect;
      const useState = React.useState;

      function Icon({name, className="h-4 w-4"}){
        const icons = {
          refresh: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6M5 19A9 9 0 1020 9"/>',
          plus: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12M6 12h12"/>',
          wallet: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h14a2 2 0 012 2v6a2 2 0 01-2 2H3V7zm0 0V5a2 2 0 012-2h11"/>',
          user: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A7 7 0 0112 15a7 7 0 016.879 2.804M15 10a3 3 0 11-6 0 3 3 0 016 0z"/>'
        };
        return React.createElement('svg', {xmlns:'http://www.w3.org/2000/svg', viewBox:'0 0 24 24', fill:'none', stroke:'currentColor', className}, React.createElement('g', {dangerouslySetInnerHTML:{__html:icons[name]||''}}));
      }

      function App() {
        const [token, setToken] = useState("");
        const [tasks, setTasks] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");
        const [balance, setBalance] = useState(null);
        const [profile, setProfile] = useState(null);

        // Ensure Telegram WebApp marks the app as ready to avoid "Load failed" overlay
        useEffect(() => {
          const tg = window.Telegram && window.Telegram.WebApp;
          if (tg) {
            try {
              tg.ready();
              if (typeof tg.expand === 'function') tg.expand();
              try { tg.setHeaderColor('#0b3b7e'); } catch(_e) {}
              // Sync theme class once React mounts
              try {
                const cs = tg.colorScheme;
                const root = document.documentElement;
                if (cs === 'dark' || !cs) root.classList.add('tg-dark');
                else root.classList.remove('tg-dark');
              } catch(_e) {}
            } catch (e) {
              // no-op
            }
          }
        }, []);

        // Wire Telegram MainButton for "Старт" until authorized
        useEffect(() => {
          const tg = window.Telegram && window.Telegram.WebApp;
          if (!tg) return;
          try {
            const mb = tg.MainButton;
            if (!token) {
              mb.setText('Старт');
              try { mb.enable && mb.enable(); } catch(_e) {}
              mb.show();
              const onStart = function(){
                try { tg.HapticFeedback && tg.HapticFeedback.impactOccurred && tg.HapticFeedback.impactOccurred('medium'); } catch(_e) {}
                auth();
              };
              mb.onClick(onStart);
              // keep reference on window to remove later
              window.__tgOnStart = onStart;
            } else {
              mb.hide();
              try {
                const cb = window.__tgOnStart || auth;
                mb.offClick && mb.offClick(cb);
                delete window.__tgOnStart;
              } catch(_e) {}
            }
          } catch(_e) {}
          return () => {
            try {
              const cb = window.__tgOnStart || auth;
              tg.MainButton && tg.MainButton.offClick && tg.MainButton.offClick(cb);
              delete window.__tgOnStart;
            } catch(_e) {}
          };
        }, [token]);

        const urlApi = new URLSearchParams(location.search).get('api');
        const API = ((urlApi && decodeURIComponent(urlApi)) || window.__API_BASE__ || "http://127.0.0.1:8001").replace(/\/$/, "");

        const getInitData = () => {
          const tg = window.Telegram && window.Telegram.WebApp;
          if (tg && tg.initData && tg.initData.length > 0) {
            return tg.initData; // real URL-encoded initData from Telegram
          }
          // fallback for local testing
          return "1001:Ruslan:ruslan";
        };

        const viewBalance = async () => {
          if (!token) return;
          setError("");
          try {
            const r = await fetch(API + "/balance?token=" + encodeURIComponent(token));
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || "Balance error");
            setBalance(d);
          } catch (e) { setError(String(e.message || e)); }
        };

        const viewProfile = async () => {
          if (!token) return;
          setError("");
          try {
            const r = await fetch(API + "/profile?token=" + encodeURIComponent(token));
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || "Profile error");
            setProfile(d);
          } catch (e) { setError(String(e.message || e)); }
        };

        const takeTask = async (id) => {
          if (!token) return;
          setError("");
          try {
            const r = await fetch(API + `/tasks/${id}/take?token=` + encodeURIComponent(token), { method: "POST" });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || "Take error");
            await loadTasks();
          } catch (e) { setError(String(e.message || e)); }
        };

        const completeTask = async (id) => {
          if (!token) return;
          setError("");
          try {
            const r = await fetch(API + `/tasks/${id}/complete?token=` + encodeURIComponent(token), { method: "POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ result_text: "Done" }) });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || "Complete error");
            await loadTasks();
          } catch (e) { setError(String(e.message || e)); }
        };

        const confirmTask = async (id) => {
          if (!token) return;
          setError("");
          try {
            const r = await fetch(API + `/tasks/${id}/confirm?token=` + encodeURIComponent(token), { method: "POST" });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || "Confirm error");
            await loadTasks();
          } catch (e) { setError(String(e.message || e)); }
        };

        const rejectTask = async (id) => {
          if (!token) return;
          setError("");
          try {
            const r = await fetch(API + `/tasks/${id}/reject?token=` + encodeURIComponent(token), { method: "POST" });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || "Reject error");
            await loadTasks();
          } catch (e) { setError(String(e.message || e)); }
        };

        const auth = async () => {
          setError("");
          try {
            const tg = window.Telegram && window.Telegram.WebApp;
            if (tg && tg.expand) tg.expand();
            const initData = getInitData();
            const body = new URLSearchParams({ initData });
            const r = await fetch(API + "/auth/telegram", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || "Auth error");
            setToken(d.token || "");
          } catch (e) {
            setError(String(e.message || e));
          }
        };

        const loadTasks = async () => {
          setLoading(true);
          setError("");
          try {
            const r = await fetch(API + "/tasks");
            const d = await r.json();
            setTasks(d.items || []);
          } catch (e) {
            setError(String(e.message || e));
          } finally {
            setLoading(false);
          }
        };

        const createDemoTask = async () => {
          if (!token) return;
          setError("");
          try {
            const payload = {
              title: "Design logo",
              description: "Simple TG-style logo",
              price: 150,
              category: "design"
            };
            const r = await fetch(API + "/tasks?token=" + encodeURIComponent(token), {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || "Create task error");
            await loadTasks();
          } catch (e) {
            setError(String(e.message || e));
          }
        };

        useEffect(function () {
          auth().then(loadTasks);
        }, []);

      return React.createElement(
        "div",
        { className: "max-w-3xl mx-auto p-4" },
        React.createElement(
          "header",
          { className: "rounded-2xl bg-gradient-to-r from-sky-500 to-emerald-500 text-white p-4 mb-4 shadow" },
          React.createElement("div", { className:"flex items-center justify-between"},
            React.createElement("div", {className:"flex items-center gap-2"},
              React.createElement("div", {className:"h-9 w-9 rounded-xl bg-white/15 flex items-center justify-center"},
                React.createElement("svg", {xmlns:"http://www.w3.org/2000/svg", viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", className:"h-5 w-5"},
                  React.createElement("path", {d:"M4 4h16v6H4zM4 14h10v6H4z", strokeWidth:2, strokeLinecap:"round", strokeLinejoin:"round"})
                )
              ),
              React.createElement("h1", { className: "text-lg font-semibold" }, "TaskBoard")
            ),
            React.createElement("span", { className: "text-xs bg-white/15 px-2 py-1 rounded-full" }, token ? "Авторизован" : "Не авторизован")
          )
        ),
        error && React.createElement("div", { className: "mb-3 p-3 rounded-xl bg-rose-50 text-rose-700 border border-rose-200" }, error),
        React.createElement(
          "div",
          { className: "grid grid-cols-2 gap-2 mb-4" },
          React.createElement("button", { onClick: loadTasks, className: "flex items-center justify-center gap-2 px-3 py-3 rounded-xl bg-white shadow-sm ring-1 ring-slate-200 active:scale-[0.99]" },
            React.createElement(Icon, {name:"refresh", className:"h-4 w-4 text-sky-600"}), loading ? "Загрузка..." : "Обновить"),
          React.createElement("button", { onClick: createDemoTask, disabled: !token, className: "flex items-center justify-center gap-2 px-3 py-3 rounded-xl bg-white shadow-sm ring-1 ring-slate-200 disabled:opacity-50 active:scale-[0.99]" },
            React.createElement(Icon, {name:"plus", className:"h-4 w-4 text-emerald-600"}), "Демо-заказ"),
          React.createElement("button", { onClick: viewBalance, disabled: !token, className: "flex items-center justify-center gap-2 px-3 py-3 rounded-xl bg-white shadow-sm ring-1 ring-slate-200 disabled:opacity-50 active:scale-[0.99]" },
            React.createElement(Icon, {name:"wallet", className:"h-4 w-4 text-indigo-600"}), "Баланс"),
          React.createElement("button", { onClick: viewProfile, disabled: !token, className: "flex items-center justify-center gap-2 px-3 py-3 rounded-xl bg-white shadow-sm ring-1 ring-slate-200 disabled:opacity-50 active:scale-[0.99]" },
            React.createElement(Icon, {name:"user", className:"h-4 w-4 text-slate-700"}), "Профиль")
        ),
        React.createElement(
          "div",
          { className: "space-y-3" },
          (tasks || []).map(function (t) {
            return React.createElement(
              "div",
              { key: t.id, className: "p-4 bg-white rounded-2xl shadow-sm ring-1 ring-slate-200" },
              React.createElement(
                "div",
                { className: "flex items-center justify-between mb-1" },
                React.createElement("h2", { className: "font-semibold text-slate-800" }, t.title),
                React.createElement("span", { className: "text-emerald-600 font-semibold" }, String(t.price) + " монет")
              ),
              React.createElement("p", { className: "text-sm text-slate-600 mb-2" }, t.description),
              React.createElement("div", { className: "text-xs text-slate-500 mb-3" }, "Категория: " + t.category + " · Статус: " + t.status),
              React.createElement("div", { className: "flex gap-2" },
                React.createElement("button", { className: "px-3 py-2 rounded-lg bg-sky-600 text-white disabled:opacity-50", disabled: !token || t.status !== 'free', onClick: () => takeTask(t.id) }, "Взять"),
                React.createElement("button", { className: "px-3 py-2 rounded-lg bg-amber-500 text-white disabled:opacity-50", disabled: !token || t.status !== 'taken', onClick: () => completeTask(t.id) }, "Завершить"),
                React.createElement("button", { className: "px-3 py-2 rounded-lg bg-emerald-600 text-white disabled:opacity-50", disabled: !token || t.status !== 'completed', onClick: () => confirmTask(t.id) }, "Подтвердить"),
                React.createElement("button", { className: "px-3 py-2 rounded-lg bg-rose-600 text-white disabled:opacity-50", disabled: !token || (t.status !== 'taken' && t.status !== 'completed'), onClick: () => rejectTask(t.id) }, "Отклонить")
              )
            );
          })
        )
        , (balance ? React.createElement("div", { className: "mt-4 p-4 bg-white rounded-2xl shadow-sm ring-1 ring-slate-200" },
            React.createElement("div", { className: "font-semibold mb-1 text-slate-800" }, "Баланс: ", balance.balance, " монет"),
            React.createElement("div", { className: "text-sm text-slate-600" }, "Транзакций: ", (balance.history||[]).length)
          ) : null)
        , (profile ? React.createElement("div", { className: "mt-4 p-4 bg-white rounded-2xl shadow-sm ring-1 ring-slate-200" },
            React.createElement("div", { className: "font-semibold mb-1 text-slate-800" }, "Профиль"),
            React.createElement("pre", { className: "text-xs text-slate-600 whitespace-pre-wrap" }, JSON.stringify(profile, null, 2))
          ) : null)
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>
  </body>
  </html>
