<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaskBoard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div id="root"></div>
    <script>
      const useEffect = React.useEffect;
      const useState = React.useState;

      function App() {
        const [token, setToken] = useState("");
        const [tasks, setTasks] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");

        const API = "http://127.0.0.1:8000";

        const getInitData = () => {
          const tg = window.Telegram && window.Telegram.WebApp;
          if (tg && tg.initData && tg.initData.length > 0) {
            return tg.initData; // real URL-encoded initData from Telegram
          }
          // fallback for local testing
          return "1001:Ruslan:ruslan";
        };

        const auth = async () => {
          setError("");
          try {
            const tg = window.Telegram && window.Telegram.WebApp;
            if (tg && tg.expand) tg.expand();
            const initData = getInitData();
            const body = new URLSearchParams({ initData });
            const r = await fetch(API + "/auth/telegram", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || "Auth error");
            setToken(d.token || "");
          } catch (e) {
            setError(String(e.message || e));
          }
        };

        const loadTasks = async () => {
          setLoading(true);
          setError("");
          try {
            const r = await fetch(API + "/tasks");
            const d = await r.json();
            setTasks(d.items || []);
          } catch (e) {
            setError(String(e.message || e));
          } finally {
            setLoading(false);
          }
        };

        const createDemoTask = async () => {
          if (!token) return;
          setError("");
          try {
            const payload = {
              title: "Design logo",
              description: "Simple TG-style logo",
              price: 150,
              category: "design"
            };
            const r = await fetch(API + "/tasks?token=" + encodeURIComponent(token), {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || "Create task error");
            await loadTasks();
          } catch (e) {
            setError(String(e.message || e));
          }
        };

        useEffect(function () {
          auth().then(loadTasks);
        }, []);

        return React.createElement(
          "div",
          { className: "max-w-3xl mx-auto p-4" },
          React.createElement(
            "header",
            { className: "flex items-center justify-between mb-4" },
            React.createElement("h1", { className: "text-xl font-semibold text-blue-600" }, "TaskBoard"),
            React.createElement("div", { className: "text-sm text-gray-600" }, token ? "Авторизован" : "Не авторизован")
          ),
          error && React.createElement("div", { className: "mb-3 p-3 rounded bg-red-50 text-red-700" }, error),
          React.createElement(
            "div",
            { className: "flex gap-2 mb-4" },
            React.createElement("button", { onClick: loadTasks, className: "px-3 py-2 bg-blue-600 text-white rounded shadow" }, loading ? "Загрузка..." : "Обновить ленту"),
            React.createElement("button", { onClick: createDemoTask, disabled: !token, className: "px-3 py-2 bg-emerald-600 text-white rounded shadow disabled:opacity-50" }, "Создать демо-заказ")
          ),
          React.createElement(
            "div",
            { className: "space-y-3" },
            (tasks || []).map(function (t) {
              return React.createElement(
                "div",
                { key: t.id, className: "p-4 bg-white rounded-xl shadow" },
                React.createElement(
                  "div",
                  { className: "flex items-center justify-between mb-1" },
                  React.createElement("h2", { className: "font-semibold" }, t.title),
                  React.createElement("span", { className: "text-emerald-600 font-medium" }, String(t.price) + " монет")
                ),
                React.createElement("p", { className: "text-sm text-gray-600 mb-2" }, t.description),
                React.createElement("div", { className: "text-xs text-gray-500" }, "Категория: " + t.category + " · Статус: " + t.status)
              );
            })
          )
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
    </script>
  </body>
  </html>
